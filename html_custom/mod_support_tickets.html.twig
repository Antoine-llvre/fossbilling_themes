{% extends request.ajax ? "layout_blank.html.twig" : "layout_default.html.twig" %}
{% import "macro_functions.html.twig" as mf %}

{% block meta_title %}{{ 'Support tickets'|trans }}{% endblock %}
{% block page_header %}{{ 'Support tickets'|trans }}{% endblock %}
{% block body_class %}support-tickets{% endblock %}
{% block breadcrumb %}<li class="breadcrumb-item active" aria-current="page">{{ 'Support tickets'|trans }}</li>{% endblock %}

{% block head %}
  {{ mf.wysiwyg('.editor-textarea') }}
  <style>
    :root{ --ow-border: var(--bs-border-color,#e5e7eb); --ow-shadow:0 8px 18px rgba(13,71,255,.06); }
    .ow-card{background:#fff;border:1px solid var(--ow-border);border-radius:16px;box-shadow:var(--ow-shadow)}
    .ow-hd{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid var(--ow-border)}
    .ow-hd h2{margin:0;font-size:1.05rem;font-weight:800}
    .ow-bd{padding:18px}
    .table thead th{font-size:.85rem;text-transform:uppercase;letter-spacing:.3px;color:#6b7280}
    .badge.round{border-radius:999px}
    .btn{border-radius:12px}
    .form-control, .form-select{border-radius:12px}
  </style>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-12">
    <div class="ow-card mb-4">
      <div class="ow-hd">
        <div>
          <h2>{{ 'Support tickets'|trans }}</h2>
          <div class="small text-secondary">{{ 'Need an answer? We are here to help!'|trans }}</div>
        </div>
        <div>
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#open-ticket-modal">
            <i class="bi bi-plus-lg me-1"></i>{{ 'New ticket'|trans }}
          </button>
        </div>
      </div>

      <div class="ow-bd table-responsive">
        {% set tickets = client.support_ticket_get_list({"per_page":10, "page":request.page}) %}
        {% if tickets.list %}
          <table class="table table-striped table-hover align-middle">
            <thead>
              <tr>
                <th class="w-1">#</th>
                <th>{{ 'Subject'|trans }}</th>
                <th>{{ 'Help desk'|trans }}</th>
                <th class="text-center">{{ 'Status'|trans }}</th>
                <th>{{ 'Submitted'|trans }}</th>
                <th class="text-end">{{ 'Actions'|trans }}</th>
              </tr>
            </thead>
            <tbody>
              {% for i, ticket in tickets.list %}
              <tr>
                <td>#{{ ticket.id }}</td>
                <td>
                  <a class="text-decoration-none" href="{{ 'support/ticket'|link }}/{{ ticket.id }}">
                    {{ ticket.subject|default('No subject')|truncate(80) }}
                  </a>
                </td>
                <td>{{ ticket.helpdesk.name|default('—') }}</td>
                <td class="text-center">
                  <span class="badge round
                    {% if ticket.status == 'open' %} bg-success
                    {% elseif ticket.status == 'on_hold' %} bg-warning text-dark
                    {% elseif ticket.status == 'closed' %} bg-secondary
                    {% else %} bg-light text-dark {% endif %}">
                    {{ mf.status_name(ticket.status) }}
                  </span>
                </td>
                <td> {{ 'ago'|trans }} {{ ticket.created_at|timeago }}</td>
                <td class="text-end">
                  {% if ticket.status == 'closed' %}
                    <a href="{{ 'support/ticket'|link }}/{{ ticket.id }}" class="btn btn-sm btn-outline-secondary">
                      {{ 'View'|trans }}
                    </a>
                  {% else %}
                    <a href="{{ 'support/ticket'|link }}/{{ ticket.id }}#reply-to" class="btn btn-sm btn-outline-primary">
                      {{ 'Reply'|trans }}
                    </a>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>

          {{ include('partial_pagination.html.twig', { 'list': tickets }) }}
        {% else %}
          <div class="alert alert-info mb-0 text-center">{{ 'No support tickets'|trans }}</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{# ========= MODALE : Créer un ticket ========= #}
<div class="modal modal-lg fade" id="open-ticket-modal" tabindex="-1" aria-labelledby="open-ticket-modal" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title">{{ 'Open new ticket'|trans }}</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ 'Close'|trans }}"></button>
      </div>

      <form id="ticket-submit" class="form" style="background:none">
        <div class="modal-body">
          <input type="hidden" name="CSRFToken" value="{{ CSRFToken }}"/>

          <div class="mb-3">
            <label for="support_helpdesk_id" class="form-label">{{ 'Helpdesk'|trans }}</label>
            {# IMPORTANT : l’API attend support_helpdesk_id #}
            {{ mf.selectbox('support_helpdesk_id', client.support_helpdesk_get_pairs, request.support_helpdesk_id, 1) }}
          </div>

          <div class="mb-3">
            <label for="subject" class="form-label">{{ 'Subject'|trans }}</label>
            <input type="text" name="subject" class="form-control" id="subject" required
                   placeholder="{{ 'Briefly describe your request'|trans }}" value="{{ request.subject|e }}">
          </div>

          <div class="mb-3">
            <label for="message" class="form-label">{{ 'Message'|trans }}</label>
            <textarea name="content" class="editor-textarea form-control" id="message" rows="6" required
                      placeholder="{{ 'Add all useful details, links, screenshots…'|trans }}">{{ request.content|e }}</textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ 'Cancel'|trans }}</button>
          <button type="submit" class="btn btn-primary">{{ 'Submit'|trans }}</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block js %}
{% autoescape "js" %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const api = (window.FOSSBilling && window.FOSSBilling.api) ? window.FOSSBilling.api() : null;

  {% if request.ticket %}
    const modal = new bootstrap.Modal('#open-ticket-modal');
    modal.show();
  {% endif %}

  const form = document.getElementById('ticket-submit');
  if (form && api) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(form).entries());

      // Validation minimale
      if (!data.subject || !data.content || !data.support_helpdesk_id) {
        (window.FOSSBilling?.message || alert)("{{ 'Please fill all required fields'|trans }}", "error");
        return;
      }

      try {
        // L’endpoint correct côté client :
        const ticketId = await api.post('client/support/ticket_create', data);
        window.location.href = "{{ 'support/ticket'|link }}/" + ticketId;
      } catch (err) {
        (window.FOSSBilling?.message || alert)((err?.message || 'Error') + (err?.code ? ' ('+err.code+')' : ''), "error");
      }
    });
  }
});
</script>
{% endautoescape %}
{% endblock %}
