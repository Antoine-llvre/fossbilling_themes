{% extends request.ajax ? "layout_blank.html.twig" : "layout_default.html.twig" %}
{% import "macro_functions.html.twig" as mf %}

{# ======================= SHIM API (fallback) ======================= #}
{% block head %}{{ parent() }}
<script>
(function () {
  if (window.FOSSBilling && typeof window.FOSSBilling.api === 'function') return;
  window.FOSSBilling = window.FOSSBilling || {};
  window.FOSSBilling.api = function () {
    const base = "{{ 'api'|link }}/";
    async function post(endpoint, data) {
      const body = new URLSearchParams(data || {});
      const res = await fetch(base + endpoint, {
        method: 'POST',
        headers: {'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'},
        body
      });
      const json = await res.json();
      if (json && json.error) throw new Error(json.error.message || 'API error');
      return (json && json.result !== undefined) ? json.result : json;
    }
    return { post };
  };
})();
</script>
{% endblock %}

{% set categories = guest.product_category_get_list.list %}
{% set sel = request.cat|default(null) %}
{% set chosen = null %}
{% if sel and categories %}
  {% for c in categories %}
    {% if (sel ~ '') == (c.id ~ '') %}
      {% set chosen = c %}
    {% endif %}
  {% endfor %}
{% endif %}

{% block meta_title %}
  {% if request.order matches '/^\\d+$/' %}Configuration du produit
  {% elseif request.checkout matches '/^\\d+$/' %}Panier
  {% elseif chosen %}Choisir un produit
  {% else %}Commander{% endif %}
{% endblock %}

{% block body_class %}order-index{% endblock %}

{% block page_header %}
  {% if request.order matches '/^\\d+$/' %}Configuration du produit
  {% elseif request.checkout matches '/^\\d+$/' %}Panier
  {% elseif chosen %}Choisir un produit
  {% else %}De quel service avez-vous besoin ?{% endif %}
{% endblock %}

{% block page_subheader %}
  {% if request.order matches '/^\\d+$/' %}Paramétrez votre produit avant l’ajout au panier
  {% elseif request.checkout matches '/^\\d+$/' %}Vérifiez vos articles et procédez au paiement
  {% elseif chosen %}Choisissez un produit pour continuer la configuration
  {% else %}Choisissez une catégorie pour voir les produits disponibles{% endif %}
{% endblock %}

{% block breadcrumbs %}
<div class="mb-1">
  <ol class="breadcrumb" aria-label="breadcrumbs">
    <li class="breadcrumb-item"><a href="{{ '/'|link }}">Accueil</a></li>
    <li class="breadcrumb-item"><a href="{{ 'order'|link }}">Commander</a></li>
    {% if chosen %}<li class="breadcrumb-item active" aria-current="page">{{ chosen.title }}</li>{% endif %}
    {% if request.order matches '/^\\d+$/' %}<li class="breadcrumb-item active">Configuration</li>{% endif %}
    {% if request.checkout matches '/^\\d+$/' %}<li class="breadcrumb-item active">Panier</li>{% endif %}
  </ol>
</div>
{% endblock %}

{% block content %}

<style>
  :root{--ow-border:var(--bs-border-color,#e5e7eb);--ow-prim:#0d47ff;--ow-prim-600:#0b3fe0}
  .ow-card{background:#fff;border:1px solid var(--ow-border);border-radius:16px;box-shadow:0 8px 18px rgba(13,71,255,.06);margin-bottom:18px}
  .ow-hd{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid var(--ow-border)}
  .ow-hd h2{margin:0;font-size:1.05rem;font-weight:800}
  .ow-bd{padding:18px}
  .ow-steps{display:flex;gap:8px;align-items:center}
  .ow-step{font-size:.85rem;padding:6px 10px;border-radius:999px;background:#f3f6ff;border:1px solid #e2e8ff;color:#2743f7;font-weight:600}
  .ow-step.is-active{background:#2743f7;color:#fff;border-color:#2743f7}
  .ow-step.is-dim{opacity:.65}
  .btn-primary{background:var(--ow-prim);border-color:var(--ow-prim)} .btn-primary:hover{background:var(--ow-prim-600);border-color:var(--ow-prim-600)}
  .ow-grid{display:grid;gap:14px}
  .ow-grid.cols-1{grid-template-columns:repeat(1,1fr)}
  .ow-grid.cols-2{grid-template-columns:repeat(2,1fr)}
  .ow-grid.cols-3{grid-template-columns:repeat(3,1fr)}
  .ow-grid.cols-4{grid-template-columns:repeat(4,1fr)}
  @media (max-width:1200px){.ow-grid.cols-4{grid-template-columns:repeat(3,1fr)}}
  @media (max-width:992px){.ow-grid.cols-4,.ow-grid.cols-3{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:576px){.ow-grid.cols-4,.ow-grid.cols-3,.ow-grid.cols-2{grid-template-columns:1fr}}
  .cat-card{display:flex;align-items:center;gap:12px;padding:16px;border:1px solid var(--ow-border);border-radius:14px;background:#fff;text-decoration:none;color:inherit;transition:.18s}
  .cat-card:hover{transform:translateY(-2px);box-shadow:0 10px 24px rgba(13,71,255,.10);border-color:#dbe5ff;background:#f8faff}
  .cat-icon{width:42px;height:42px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:#eef3ff}
  .cat-icon i{font-size:1.1rem;color:#0d47ff}
  .cat-title{margin:0;font-weight:800}
  .cat-count{font-size:.9rem;color:#6b7280}
  .prod-card{border:1px solid var(--ow-border);border-radius:16px;background:#fff;box-shadow:0 6px 16px rgba(13,71,255,.05);transition:.18s;display:flex;flex-direction:column}
  .prod-card:hover{transform:translateY(-2px);box-shadow:0 10px 24px rgba(13,71,255,.10);border-color:#dbe5ff}
  .prod-body{padding:16px;display:flex;flex-direction:column;height:100%}
  .prod-type{text-transform:uppercase;letter-spacing:.4px;font-weight:700;font-size:.75rem;color:#64748b}
  .prod-title{margin:6px 0 8px 0;font-weight:800;font-size:1.05rem}
  .prod-desc{color:#6b7280;font-size:.95rem}
  .prod-footer{margin-top:auto;display:flex;align-items:center;justify-content:space-between;gap:10px}
  .btn-green{background:#22c55e;color:#fff;border:none}.btn-green:hover{background:#16a34a}
  .btn-orange{background:#f59e0b;color:#fff;border:none}.btn-orange:hover{background:#d97706}
  .btn-indigo{background:#6366f1;color:#fff;border:none}.btn-indigo:hover{background:#4f46e5}
  .btn-pink{background:#ec4899;color:#fff;border:none}.btn-pink:hover{background:#db2777}
  .ow-skin .card, .ow-skin .card-header, .ow-skin .card-body{border-radius:16px;border-color:var(--ow-border)}
</style>

{# Bandeau étapes #}
<div class="ow-card">
  <div class="ow-hd">
    <h2>
      {% if request.order matches '/^\\d+$/' %}Configuration du produit
      {% elseif request.checkout matches '/^\\d+$/' %}Panier
      {% else %}Commande{% endif %}
    </h2>
    <div class="ow-steps">
      <span class="ow-step {% if not request.order and not request.checkout %}is-active{% else %}is-dim{% endif %}">1. Choisir</span>
      <span class="ow-step {% if request.order matches '/^\\d+$/' %}is-active{% else %}is-dim{% endif %}">2. Configurer</span>
      <span class="ow-step {% if request.checkout matches '/^\\d+$/' %}is-active{% else %}is-dim{% endif %}">3. Payer</span>
    </div>
  </div>
  <div class="ow-bd text-muted">
    {% if request.order matches '/^\\d+$/' %}Paramétrez votre produit avant l’ajout au panier.{% elseif request.checkout matches '/^\\d+$/' %}Vérifiez vos articles, appliquez un code promo puis procédez au paiement.{% else %}Choisissez les produits que nous proposons à la vente.{% endif %}
  </div>
</div>

{# 1) CONFIG PRODUIT #}
{% if request.order matches '/^\\d+$/' %}
  <div class="ow-card">
    <div class="ow-hd">
      <h2>Paramètres du produit</h2>
      <a class="btn btn-outline-secondary btn-sm" href="{{ 'order'|link }}">⟵ Retour à la boutique</a>
    </div>
    <div class="ow-bd ow-skin">
      {% include 'mod_orderbutton_product_configuration.html.twig' %}
    </div>
  </div>

{# 2) CHECKOUT #}
{% elseif request.checkout matches '/^\\d+$/' %}
  <div class="row g-3">
    <div class="col-12 col-lg-8">
      <div class="ow-card">
        <div class="ow-hd">
          <h2>Votre panier</h2>
          <a class="btn btn-outline-secondary btn-sm" href="{{ 'order'|link }}">Continuer mes achats</a>
        </div>
        <div class="ow-bd ow-skin">
          {% include 'mod_orderbutton_checkout.html.twig' %}
        </div>
      </div>

      {% if not client %}
        <div class="ow-card">
          <div class="ow-hd"><h2>Se connecter ou créer un compte</h2></div>
          <div class="ow-bd ow-skin">
            {% include 'mod_orderbutton_client.html.twig' %}
          </div>
        </div>
      {% endif %}
    </div>

    <div class="col-12 col-lg-4">
      <div class="ow-card" style="position:sticky;top:82px">
        <div class="ow-hd"><h2>Récapitulatif</h2></div>
        <div class="ow-bd ow-skin">
          {% include 'mod_orderbutton_checkout_table.html.twig' with { sidebar_summary_only: true } %}
          <div class="mt-3 d-grid">
            <a href="#checkout-form" class="btn btn-primary">Procéder au paiement</a>
          </div>
          <p class="text-muted small mt-2 mb-0">Paiement sécurisé. Moyens de paiement à l’étape suivante.</p>
        </div>
      </div>
    </div>
  </div>

{# 3) CATEGORIES ou PRODUITS #}
{% else %}
  {% macro cols_class(n) %}
    {%- set n = n|default(0) -%}
    {%- set c = n>=4 ? 4 : (n==3 ? 3 : (n==2 ? 2 : 1)) -%}
    {{- 'cols-' ~ c -}}
  {% endmacro %}
  {% import _self as util %}

  {% if chosen %}
    {% set prods = (chosen.products|default([]))|sort((a,b)=>a.priority<=>b.priority) %}
    <div class="ow-card">
      <div class="ow-hd">
        <h2>{{ chosen.title }}</h2>
        <a class="btn btn-sm btn-light" href="{{ 'order'|link }}"><i class="bi bi-arrow-left me-1"></i>Retour aux catégories</a>
      </div>
      {% if chosen.description %}<div class="ow-bd"><div class="text-muted">{{ chosen.description|markdown }}</div></div>{% endif %}
      <div class="ow-bd">
        {% if not prods or prods|length == 0 %}
          <div class="text-muted">Aucun produit dans cette catégorie</div>
        {% else %}
          <div class="ow-grid {{ util.cols_class(prods|length) }}">
            {% for product in prods %}
              <div class="prod-card">
                <div class="prod-body">
                  <div class="prod-type">{{ product.type }}</div>
                  <div class="prod-title">{{ product.title }}</div>
                  {% set pd = product.description|default('') %}
                  {% if pd %}<div class="prod-desc">{{ pd|striptags|truncate(220) }}</div>{% endif %}
                  <div class="prod-footer pt-2">
                    <span class="text-muted"></span>
                    <a href="{{ 'orderbutton'|link({ 'order': product.id, 'show_custom_form_values': request.show_custom_form_values }) }}"
                       class="btn {% if product.type == 'domain' %}btn-green{% elseif product.type == 'hosting' %}btn-orange{% elseif product.type == 'downloadable' %}btn-indigo{% elseif product.type == 'license' %}btn-pink{% else %}btn-dark{% endif %}">
                      Choisir
                    </a>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
  {% else %}
    {% set cat_count = categories ? categories|length : 0 %}
    <div class="ow-card">
      <div class="ow-hd"><h2>De quel service avez-vous besoin ?</h2></div>
      <div class="ow-bd">
        {% if not categories or categories|length == 0 %}
          <div class="text-muted">Aucune catégorie disponible</div>
        {% else %}
          <div class="ow-grid {{ util.cols_class(cat_count) }}">
            {% for cat in categories %}
              {% set title_lc = (cat.title|lower) %}
              {% set icon = 'bi-box' %}
              {% if 'domaine' in title_lc or 'domain' in title_lc %}{% set icon = 'bi-globe' %}{% endif %}
              {% if 'hébergement' in title_lc or 'hosting' in title_lc %}{% set icon = 'bi-hdd-network' %}{% endif %}
              {% if 'serveur' in title_lc or 'vps' in title_lc %}{% set icon = 'bi-cpu' %}{% endif %}
              {% if 'email' in title_lc or 'mail' in title_lc %}{% set icon = 'bi-envelope-paper' %}{% endif %}

              <a class="cat-card" href="{{ 'order'|link }}?cat={{ cat.id }}">
                <div class="cat-icon"><i class="bi {{ icon }}"></i></div>
                <div class="flex-grow-1">
                  <p class="cat-title">{{ cat.title }}</p>
                  <div class="cat-count">{{ (cat.products|default([]))|length }} produit(s)</div>
                  {% if cat.description %}<div class="text-muted small mt-1">{{ cat.description|striptags|truncate(120) }}</div>{% endif %}
                </div>
              </a>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
  {% endif %}
{% endif %}

{% endblock %}
